package com.wozai.common.utils.catchnuist;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.PrintWriter;
import java.io.UnsupportedEncodingException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import java.util.Scanner;
import java.util.regex.Matcher;
import java.util.regex.Pattern;


import com.wozai.cache.HttpLoginHelper;
import org.apache.http.HttpResponse;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.CookieStore;
import org.apache.http.client.HttpClient;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.cookie.Cookie;
import org.apache.http.message.BasicNameValuePair;
import org.apache.log4j.Logger;

public class SimpleLogin {
    private static final Logger logger = Logger.getLogger("com.wozai.common.utils.catchnuist.SimpleLogin");
	public final String URL = "http://wlkt.nuist.edu.cn";
	public String rootUrl = "";
	public String jscxUrl = "/public/jxcdkebiaoall.aspx";
	public CookieStore cookie;
	public Boolean getLoginPage(String username,String password) throws FileNotFoundException, IOException, InterruptedException{
		//访问主页
        logger.info("[调用http查询用户信息]:" + username + " : " + password);
		HttpResponse httpResponse = HttpRequestUtil.request(URL,null, HttpRequestUtil.REQUEST_TYPE_GET, "UTF-8",this);
		System.out.println("URL + code :" + httpResponse.getStatusLine().getStatusCode());
		//获取网页
		Map<String, Object> resultMap = HttpRequestUtil.getPage(URL, httpResponse,this);
		System.out.println(resultMap.get("url") + " + code :" + ((HttpResponse)resultMap.get("httpResponse")).getStatusLine().getStatusCode());
		//抓取网页 并获取其页面上的隐藏数据
		String page = (String)HttpRequestUtil.info.get("page");
		Map<String, String> map = new HashMap<String,String>();
		HttpLoginHelper.__VIEWSTATE = StringUtils.setParam(map,page).get("__VIEWSTATE");

//		System.out.println(url.get("url"));
		UrlEncodedFormEntity urlentity = setLoginValue(map,username,password);
		//第一次尝试登陆 有问题 仅能获取到相关登陆的链接
		httpResponse = HttpRequestUtil.request((String)resultMap.get("url"),urlentity, HttpRequestUtil.REQUEST_TYPE_POST, "UTF-8",this);
		resultMap = HttpRequestUtil.getPage((String)resultMap.get("url"), httpResponse,this);

		System.out.println(resultMap.get("url") + " + code :" + ((HttpResponse)resultMap.get("httpResponse")).getStatusLine().getStatusCode());
        page = (String)HttpRequestUtil.info.get("page");
        HttpLoginHelper.__VIEWSTATE = StringUtils.setParam(map,page).get("__VIEWSTATE");
        logger.info("__VIEWSTATE = " + HttpLoginHelper.__VIEWSTATE );
		//第二次登陆 正常
        HttpLoginHelper.url = (String) resultMap.get("url");
        logger.info("__VIEWSTATE = " + HttpLoginHelper.__VIEWSTATE );
		httpResponse = HttpRequestUtil.request((String) resultMap.get("url"), urlentity, HttpRequestUtil.REQUEST_TYPE_POST, "UTF-8",this);
		resultMap = HttpRequestUtil.getPage((String)resultMap.get("url"), httpResponse,this);
		httpResponse = (HttpResponse)resultMap.get("httpResponse");
        logger.info(((String) resultMap.get("url")));
		if (((String) resultMap.get("url")).contains("newslist.aspx")){
            return true;
        }else{
            return false;
        }
	}
	
	public void tryjiaoshikbcx() throws ClientProtocolException, IOException, InterruptedException{
		HttpResponse httpResponse = HttpRequestUtil.request(rootUrl+jscxUrl,null, HttpRequestUtil.REQUEST_TYPE_GET, "UTF-8",this);
		Map<String, Object> resultMap = HttpRequestUtil.getPage(rootUrl+jscxUrl, httpResponse,this);
		String page = (String)HttpRequestUtil.info.get("page");
		Map<String, String> map = new HashMap<String,String>();
		StringUtils.setParam(map,page);
		List<String>classroom  = read(page);
			for(String room : classroom){
				UrlEncodedFormEntity urlentity = setQueryValue(room,map);
				httpResponse = HttpRequestUtil.request(rootUrl+jscxUrl,urlentity, HttpRequestUtil.REQUEST_TYPE_POST, "UTF-8",this);
				resultMap = HttpRequestUtil.getPage(rootUrl+jscxUrl, httpResponse,this);
				page = (String)HttpRequestUtil.info.get("page");
				savePage(room, page);
				StringUtils.setParam(map,page);
				Thread.sleep(1000);
			}
		
	}
//	public static void main(String[] args) {
//		try {
//			getLoginPage();
//			tryjiaoshikbcx();
//		} catch (FileNotFoundException e) {
//			e.printStackTrace();
//		} catch (IOException e) {
//			e.printStackTrace();
//		} catch (InterruptedException e) {
//			e.printStackTrace();
//		}
//	}
	
	public void setRootUrl(String msg){
		rootUrl = msg.split("/public/newslist.aspx")[0];
	}
	public UrlEncodedFormEntity setLoginValue(Map<String, String> map,String username,String password) throws UnsupportedEncodingException{
		List<BasicNameValuePair> formparams = new ArrayList<BasicNameValuePair>();
		formparams.add(new BasicNameValuePair("TextBox1", username));
		formparams.add(new BasicNameValuePair("TextBox2", password));
		formparams.add(new BasicNameValuePair("js", "RadioButton3"));
		formparams.add(new BasicNameValuePair("Button1", "登陆"));
		for(String key : map.keySet()){
			formparams.add(new BasicNameValuePair(key, map.get(key)));
		}
		UrlEncodedFormEntity urlentity;
		urlentity = new UrlEncodedFormEntity(formparams, "UTF-8");
		return urlentity;
	}
	
	
	public UrlEncodedFormEntity setQueryList(String location,Map<String, String> map) throws UnsupportedEncodingException{
		List<BasicNameValuePair> formparams = new ArrayList<BasicNameValuePair>();
		formparams.add(new BasicNameValuePair("DropDownList4",location));
		formparams.add(new BasicNameValuePair("DropDownList3", "文德N307"));
		formparams.add(new BasicNameValuePair("DropDownList1","2013-2014"));
		formparams.add(new BasicNameValuePair("DropDownList2", "2"));
		formparams.add(new BasicNameValuePair("__EVENTTARGET", "DropDownList4"));
//		formparams.add(new BasicNameValuePair("__EVENTTARGET", ""));
//		formparams.add(new BasicNameValuePair("Button1", "查询"));
		formparams.add(new BasicNameValuePair("__LASTFOCUS", ""));
		formparams.add(new BasicNameValuePair("__EVENTARGUMENT", ""));
		for(String key : map.keySet()){
			formparams.add(new BasicNameValuePair(key, map.get(key)));
		}
		for(BasicNameValuePair bnv : formparams){
			System.out.println(bnv.getName() + "  " + bnv.getValue());
		}
		UrlEncodedFormEntity urlentity;
		urlentity = new UrlEncodedFormEntity(formparams, "UTF-8");
		return urlentity;
	} 
	
	public UrlEncodedFormEntity setQueryValue(String classroom,Map<String, String> map) throws UnsupportedEncodingException{
		List<BasicNameValuePair> formparams = new ArrayList<BasicNameValuePair>();
		formparams.add(new BasicNameValuePair("DropDownList4","画室"));
		formparams.add(new BasicNameValuePair("DropDownList3", classroom));
		formparams.add(new BasicNameValuePair("DropDownList1","2013-2014"));
		formparams.add(new BasicNameValuePair("DropDownList2", "2"));
//		formparams.add(new BasicNameValuePair("__EVENTTARGET", "DropDownList3"));
		formparams.add(new BasicNameValuePair("__EVENTTARGET", ""));
		formparams.add(new BasicNameValuePair("Button1", "查询"));
		formparams.add(new BasicNameValuePair("__LASTFOCUS", ""));
		formparams.add(new BasicNameValuePair("__EVENTARGUMENT", ""));
		for(String key : map.keySet()){
			formparams.add(new BasicNameValuePair(key, map.get(key)));
		}
		for(BasicNameValuePair bnv : formparams){
			System.out.println(bnv.getName() + "  " + bnv.getValue());
		}
		UrlEncodedFormEntity urlentity;
		urlentity = new UrlEncodedFormEntity(formparams, "UTF-8");
		return urlentity;
	} 
	public void savePage(String name,String msg) throws IOException{
		File f = new File("lib/class/" + name + ".txt");
		if(!f.exists()){
			f.createNewFile();
		}
		PrintWriter pw = new PrintWriter(new FileOutputStream(new File("lib/class/" + name + ".txt")), true);
		Scanner scanner = new Scanner(msg);
		while(scanner.hasNextLine()){
			pw.println(scanner.nextLine());
		}
	}
	public List<String> read(String page) throws FileNotFoundException{
		List<String> classroom = new ArrayList<String>();
		Scanner scanner = new Scanner(page);
		int flag = 0;
		while(scanner.hasNextLine()){
			String msg = scanner.nextLine();
			System.out.println(msg);
			if(flag == 0 && msg.contains("文德N307")){
				flag = 1;
			}
			if(flag == 1){
				Pattern p1 = Pattern.compile("value=\".*\"");
				Matcher m1 = p1.matcher(msg);
				while(m1.find()) {
		            String value = m1.group();
		            String[] temp = value.split("value=\"");
		            temp = temp[1].split("\"");
		            if(temp[0].equals(" ")){
		            	return classroom;
		            }
		            System.out.println(temp[0]);
		            classroom.add(temp[0]);
		        } 
			}
		}
		return classroom;
	}
	public List<String> readLocation(String page){
		List<String> keylist = new ArrayList<String>();
		Scanner scanner = new Scanner(page);
		int flag = 0;
		Pattern p1 = Pattern.compile("value=\".*\">.*</option>"); 
		while(scanner.hasNextLine()){
			String msg = scanner.nextLine();
			if(flag ==0 && msg.contains("DropDownList4")){
				flag = 1;
			}
			Matcher m1 = p1.matcher(msg);
			if(flag == 1 && m1.find()){
				String value = m1.group();
				String[] temp = value.split("value=\"");
	            temp = temp[1].split("\">");
	            if(temp[0].equals(" ")){
	            	return keylist;
	            }
	            keylist.add(temp[0]);
			}
		}
		return keylist;
	}
//	public static List<String> readClassroom(String page){
//		                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
//	}
}
